{% extends "base.html" %}

{% block title %}Suchen & Ersetzen (Regex){% endblock %}

{% block content %}
<div class="tool-page-container">
    <div class="page-header">
        <a href="{{ url_for('dashboard') }}"
            class="p-4 hover:bg-gray-100 dark:hover:bg-gray-800 rounded-full transition-colors">
            <span class="material-icons-round text-2xl">arrow_back</span>
        </a>
        <h2 class="text-3xl font-bold text-gray-800 dark:text-gray-100">Suchen & Ersetzen</h2>
    </div>

    <div class="tool-grid gap-8">
        <!-- Input Column -->
        <div class="m3-card !p-0 overflow-hidden flex flex-col min-h-[400px]">
            <div
                class="bg-gray-50 dark:bg-gray-800 border-b border-gray-100 dark:border-gray-700 p-4 flex justify-between items-center">
                <span class="font-bold text-gray-500 text-sm uppercase">Original Text</span>
                <button class="text-blue-600 dark:text-blue-400 text-sm font-bold hover:underline"
                    onclick="document.getElementById('inputText').value=''">Leeren</button>
            </div>
            <textarea id="inputText"
                class="w-full flex-1 p-6 bg-transparent outline-none resize-none font-mono text-sm leading-relaxed"
                placeholder="Füge hier deinen Text ein..." oninput="updatePreview()"></textarea>
        </div>

        <!-- Controls & Output Column -->
        <div class="flex flex-col gap-6">
            <div class="m3-card flex flex-col gap-4">
                <div class="grid grid-cols-1 gap-4">
                    <div class="m3-input-group !mb-0">
                        <label class="text-xs font-bold text-gray-500 uppercase px-1 mb-2 block">Suchen (Regex
                            möglich)</label>
                        <div class="relative">
                            <input type="text" id="findInput" class="m3-text-input font-mono !py-3"
                                placeholder="Muster z.B. \d+" oninput="updatePreview()">
                            <div class="absolute right-2 top-1/2 -translate-y-1/2 flex gap-1">
                                <button
                                    class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 text-gray-400 transition-colors"
                                    id="flag-g" title="Global (Alle finden)" onclick="toggleFlag('g')">g</button>
                                <button
                                    class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 text-gray-400 transition-colors"
                                    id="flag-i" title="Case Insensitive (Groß/Klein egal)"
                                    onclick="toggleFlag('i')">i</button>
                                <button
                                    class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 text-gray-400 transition-colors"
                                    id="flag-m" title="Multiline" onclick="toggleFlag('m')">m</button>
                            </div>
                        </div>
                    </div>
                    <div class="m3-input-group !mb-0">
                        <label class="text-xs font-bold text-gray-500 uppercase px-1 mb-2 block">Ersetzen mit</label>
                        <input type="text" id="replaceInput" class="m3-text-input font-mono !py-3"
                            placeholder="Ersatztext" oninput="updatePreview()">
                    </div>
                </div>
            </div>

            <div class="m3-card !p-0 overflow-hidden flex flex-col flex-1 min-h-[300px] border-2 border-transparent transition-colors"
                id="resultCard">
                <div
                    class="bg-gray-50 dark:bg-gray-800 border-b border-gray-100 dark:border-gray-700 p-4 flex justify-between items-center">
                    <span class="font-bold text-gray-500 text-sm uppercase">Ergebnis</span>
                    <button class="text-blue-600 dark:text-blue-400 text-sm font-bold hover:underline"
                        onclick="copyResult()">Kopieren</button>
                </div>
                <textarea id="outputText"
                    class="w-full flex-1 p-6 bg-transparent outline-none resize-none font-mono text-sm leading-relaxed"
                    readonly></textarea>
            </div>

            <div class="text-xs text-center text-gray-400" id="stats">
                0 Treffer gefunden
            </div>
        </div>
    </div>
</div>

<style>
    .flag-active {
        color: var(--m3-primary) !important;
        background-color: var(--m3-primary-container) !important;
        font-weight: bold;
    }
</style>

<script>
    let flags = { g: true, i: false, m: false };

    // Set defaults
    updateFlagUI();

    function toggleFlag(f) {
        flags[f] = !flags[f];
        updateFlagUI();
        updatePreview();
    }

    function updateFlagUI() {
        ['g', 'i', 'm'].forEach(f => {
            const btn = document.getElementById(`flag-${f}`);
            if (flags[f]) btn.classList.add('flag-active');
            else btn.classList.remove('flag-active');
        });
    }

    function updatePreview() {
        const text = document.getElementById('inputText').value;
        const find = document.getElementById('findInput').value;
        const replace = document.getElementById('replaceInput').value;
        const output = document.getElementById('outputText');
        const stats = document.getElementById('stats');
        const resultCard = document.getElementById('resultCard');

        if (!text || !find) {
            output.value = text;
            stats.innerText = '';
            resultCard.classList.remove('border-blue-500');
            return;
        }

        try {
            let flagStr = '';
            if (flags.g) flagStr += 'g';
            if (flags.i) flagStr += 'i';
            if (flags.m) flagStr += 'm';

            const regex = new RegExp(find, flagStr);

            // Count matches
            const matches = text.match(regex);
            const count = matches ? matches.length : 0;
            stats.innerText = `${count} Treffer gefunden`;

            // Replace
            const result = text.replace(regex, replace);
            output.value = result;

            // Visual feedback
            resultCard.classList.remove('border-red-500');
            if (count > 0) {
                resultCard.classList.add('border-blue-500');
            } else {
                resultCard.classList.remove('border-blue-500');
            }

        } catch (e) {
            stats.innerText = 'Ungültiger Regex';
            resultCard.classList.add('border-red-500');
        }
    }

    function copyResult() {
        const text = document.getElementById('outputText').value;
        if (text) {
            navigator.clipboard.writeText(text);
            showToast('Ergebnis kopiert!');
        }
    }
</script>
{% endblock %}