{% extends "base.html" %}

{% block title %}{{ cloud.title }}{% endblock %}

{% block content %}
<div class="flex flex-col items-center min-h-[80vh] gap-8">
    <div class="m3-card max-w-[600px] w-full">
        <div class="text-center mb-6">
            <span class="material-icons-round text-6xl text-blue-600 mb-4">cloud_queue</span>
            <h1 class="text-2xl font-bold text-gray-800">{{ cloud.title }}</h1>
            <p class="text-gray-500 mt-2">{{ cloud.description or "Schreibe Begriffe auf, die dir dazu einfallen!" }}
            </p>
        </div>

        <div class="space-y-4">
            <div class="m3-input-group !mb-2">
                <input type="text" id="wordInput" class="m3-text-input" placeholder="Dein Begriff..." maxlength="30">
            </div>
            <div class="flex gap-2">
                <input type="text" id="voterName" class="m3-text-input !mb-0 !py-2 text-sm"
                    placeholder="Dein Name (optional)">
                <button onclick="submitWord()" id="submitBtn" class="m3-button m3-button-filled !w-auto !px-6">
                    Senden
                    <span class="material-icons-round">send</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Word Cloud Display -->
    <div class="m3-card !bg-white dark:!bg-gray-800 min-h-[400px] flex items-center justify-center relative overflow-hidden p-8"
        id="cloudContainer">
        <div id="wordCloud" class="flex flex-wrap items-center justify-center gap-4 max-w-4xl">
            <!-- Words injected here -->
            <p class="text-gray-400 animate-pulse">Lade Wortwolke...</p>
        </div>
    </div>
</div>

<style>
    .cloud-word {
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        cursor: default;
        display: inline-block;
        line-height: 1;
        padding: 2px 4px;
    }

    .cloud-word:hover {
        transform: scale(1.1) !important;
        filter: brightness(1.2);
        z-index: 10;
    }
</style>

<script>
    async function submitWord() {
        const word = document.getElementById('wordInput').value.trim();
        const name = document.getElementById('voterName').value.trim() || 'Anonym';

        if (!word) {
            showToast('Wort eingeben!');
            return;
        }

        const btn = document.getElementById('submitBtn');
        btn.disabled = true;

        try {
            const response = await fetch('/api/wordcloud/{{ cloud.slug }}/submit', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ word: word, name: name })
            });

            if (response.ok) {
                document.getElementById('wordInput').value = '';
                showToast('Gesendet!');
                loadCloudData();
            } else {
                const res = await response.json();
                showToast(res.error);
            }
        } catch (e) {
            showToast('Fehler beim Senden');
        } finally {
            btn.disabled = false;
        }
    }

    async function loadCloudData() {
        try {
            const response = await fetch('/api/wordcloud/{{ cloud.slug }}/data');
            const data = await response.json();
            renderCloud(data.words);
        } catch (e) {
            console.error('Error loading cloud data:', e);
        }
    }

    function renderCloud(words) {
        const container = document.getElementById('wordCloud');
        if (!words || words.length === 0) {
            container.innerHTML = '<p class="text-gray-400">Noch keine WÃ¶rter vorhanden. Sei der Erste!</p>';
            return;
        }

        // Keep current content if it matches to avoid flickering (simple check)
        const currentData = container.getAttribute('data-last-sync');
        const newData = JSON.stringify(words.map(w => ({ t: w.text, s: w.size })));
        if (currentData === newData) return;
        container.setAttribute('data-last-sync', newData);

        container.innerHTML = '';

        const maxCount = Math.max(...words.map(w => w.size));
        const minCount = Math.min(...words.map(w => w.size));

        const colors = [
            '#6750A4', '#9333ea', '#db2777', '#dc2626', '#ea580c',
            '#0284c7', '#16a34a', '#0891b2', '#4f46e5', '#7d5260'
        ];

        // Stable sort to prevent jumping
        words.sort((a, b) => a.text.localeCompare(b.text));

        words.forEach(word => {
            let fontSize = 1;
            if (maxCount === minCount) {
                fontSize = 1.5;
            } else {
                fontSize = 1 + (word.size - minCount) / (maxCount - minCount) * 2.5;
            }

            const span = document.createElement('span');
            span.className = 'cloud-word font-bold animate-fade-in';
            span.textContent = word.text;
            span.style.fontSize = fontSize + 'rem';

            // Deterministic color based on word string
            let hash = 0;
            for (let i = 0; i < word.text.length; i++) hash = word.text.charCodeAt(i) + ((hash << 5) - hash);
            span.style.color = colors[Math.abs(hash) % colors.length];

            // Deterministic rotation
            const rotate = (Math.abs(hash % 20) - 10);
            span.style.transform = `rotate(${rotate}deg)`;
            span.title = `${word.size}x genannt`;

            container.appendChild(span);
        });
    }

    // Initial load
    loadCloudData();
    // Live Auto Refresh every 3 seconds
    setInterval(loadCloudData, 3000);
</script>
{% endblock %}