{% extends "base.html" %}

{% block title %}{{ cloud.title }}{% endblock %}

{% block content %}
<div class="flex flex-col items-center min-h-[80vh] gap-8">
    <div class="m3-card max-w-[600px] w-full">
        <div class="text-center mb-6">
            <span class="material-icons-round text-6xl text-blue-600 mb-4">cloud_queue</span>
            <h1 class="text-2xl font-bold text-gray-800">{{ cloud.title }}</h1>
            <p class="text-gray-500 mt-2">{{ cloud.description or "Schreibe Begriffe auf, die dir dazu einfallen!" }}
            </p>
        </div>

        <div class="space-y-4">
            <div class="m3-input-group !mb-2">
                <input type="text" id="wordInput" class="m3-text-input" placeholder="Dein Begriff..." maxlength="30">
            </div>
            <div class="flex gap-2">
                <input type="text" id="voterName" class="m3-text-input !mb-0 !py-2 text-sm"
                    placeholder="Dein Name (optional)">
                <button onclick="submitWord()" id="submitBtn" class="m3-button m3-button-filled !w-auto !px-6">
                    Senden
                    <span class="material-icons-round">send</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Word Cloud Display -->
    <div class="m3-card !bg-white dark:!bg-gray-800 min-h-[400px] flex items-center justify-center relative overflow-hidden p-8"
        id="cloudContainer">
        <div id="wordCloud" class="flex flex-wrap items-center justify-center gap-4 max-w-4xl">
            <!-- Words injected here -->
            <p class="text-gray-400 animate-pulse">Lade Wortwolke...</p>
        </div>
    </div>
</div>

<style>
    .cloud-word {
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        cursor: default;
        display: inline-block;
        line-height: 1;
        padding: 2px 4px;
    }

    .cloud-word:hover {
        transform: scale(1.1) !important;
        filter: brightness(1.2);
        z-index: 10;
    }
</style>

<script>
    async function submitWord() {
        const word = document.getElementById('wordInput').value.trim();
        const name = document.getElementById('voterName').value.trim() || 'Anonym';

        if (!word) {
            showToast('Wort eingeben!');
            return;
        }

        const btn = document.getElementById('submitBtn');
        btn.disabled = true;

        try {
            const response = await fetch('/api/wordcloud/{{ cloud.slug }}/submit', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ word: word, name: name })
            });

            if (response.ok) {
                document.getElementById('wordInput').value = '';
                showToast('Gesendet!');
                loadCloudData();
            } else {
                const res = await response.json();
                showToast(res.error);
            }
        } catch (e) {
            showToast('Fehler beim Senden');
        } finally {
            btn.disabled = false;
        }
    }

    async function loadCloudData() {
        try {
            const response = await fetch('/api/wordcloud/{{ cloud.slug }}/data');
            const data = await response.json();
            renderCloud(data.words);
        } catch (e) {
            console.error('Error loading cloud data:', e);
        }
    }

    function renderCloud(words) {
        const container = document.getElementById('wordCloud');
        if (!words || words.length === 0) {
            container.innerHTML = '<p class="text-gray-400">Noch keine WÃ¶rter vorhanden. Sei der Erste!</p>';
            return;
        }

        container.innerHTML = '';

        // Find max size for normalization
        const maxCount = Math.max(...words.map(w => w.size));
        const minCount = Math.min(...words.map(w => w.size));

        const colors = [
            '#2563eb', '#7c3aed', '#db2777', '#dc2626', '#ea580c',
            '#ca8a04', '#16a34a', '#0891b2', '#4f46e5', '#9333ea'
        ];

        // Sort words slightly randomly but keep important ones central? 
        // Just sort alphabetically then shuffle a bit.
        words.sort(() => Math.random() - 0.5);

        words.forEach(word => {
            // Calculate font size (range 0.8rem to 4rem)
            let fontSize = 1;
            if (maxCount === minCount) {
                fontSize = 1.5;
            } else {
                fontSize = 1 + (word.size - minCount) / (maxCount - minCount) * 3;
            }

            const span = document.createElement('span');
            span.className = 'cloud-word font-bold';
            span.textContent = word.text;
            span.style.fontSize = fontSize + 'rem';
            span.style.color = colors[Math.floor(Math.random() * colors.length)];

            // Random slight rotation
            const rotate = (Math.random() - 0.5) * 20;
            span.style.transform = `rotate(${rotate}deg)`;

            // Tooltip or small indicator for count
            span.title = `${word.size}x genannt`;

            container.appendChild(span);
        });
    }

    // Initial load
    loadCloudData();
    // Auto refresh every 30 seconds
    setInterval(loadCloudData, 30000);
</script>
{% endblock %}