{% extends "base.html" %}

{% block title %}Video Downloader{% endblock %}

{% block content %}
<div class="tool-page-container">
    <div class="page-header">
        <a href="{{ url_for('dashboard') }}"
            class="p-4 hover:bg-gray-100 dark:hover:bg-gray-800 rounded-full transition-colors">
            <span class="material-icons-round text-2xl">arrow_back</span>
        </a>
        <h2 class="text-3xl font-bold text-gray-800 dark:text-gray-100">Video Downloader</h2>
    </div>

    <div class="max-w-4xl mx-auto mt-8">
        <div class="m3-card !p-8 animate-fade-in">
            <div class="flex flex-col gap-8">
                <!-- Header with Icon -->
                <div class="flex items-center gap-6">
                    <div class="bg-[var(--m3-primary-container)] text-[var(--m3-on-primary-container)] p-5 rounded-3xl">
                        <span class="material-icons-round text-4xl">download_for_offline</span>
                    </div>
                    <div>
                        <h3 class="text-2xl font-bold text-gray-800 dark:text-white">Medien herunterladen</h3>
                        <p class="text-gray-500 dark:text-gray-400 mt-1">Unterstützt YouTube, Vimeo, TikTok und viele
                            mehr.</p>
                    </div>
                </div>

                <!-- Input Section -->
                <div class="space-y-6">
                    <div class="m3-input-group">
                        <label class="text-xs font-bold text-gray-500 uppercase px-1 mb-2 block">Video / Audio
                            Link</label>
                        <div class="relative flex gap-2">
                            <div class="relative flex-1">
                                <input type="url" id="mediaUrl" class="m3-text-input pl-12 py-4 text-lg"
                                    placeholder="https://www.youtube.com/watch?v=..." required>
                                <span
                                    class="material-icons-round absolute left-4 top-1/2 -translate-y-1/2 text-gray-400 text-2xl">link</span>
                            </div>
                            <button id="searchBtn" class="m3-button m3-button-tonal py-4 px-6 rounded-2xl"
                                onclick="fetchInfo()">
                                <span class="material-icons-round">search</span>
                            </button>
                        </div>
                    </div>

                    <!-- Preview Section -->
                    <div id="previewCard"
                        class="hidden animate-fade-in bg-gray-50 dark:bg-gray-800/50 rounded-3xl p-6 border border-gray-100 dark:border-gray-700">
                        <div class="flex flex-col md:flex-row gap-6">
                            <div
                                class="relative w-full md:w-48 aspect-video rounded-2xl overflow-hidden bg-black flex-shrink-0">
                                <img id="videoThumbnail" src="" alt="Thumbnail" class="w-full h-full object-cover">
                                <div id="videoDuration"
                                    class="absolute bottom-2 right-2 bg-black/80 text-white text-[10px] px-2 py-1 rounded-md font-bold">
                                </div>
                            </div>
                            <div class="flex-1">
                                <h4 id="videoTitle"
                                    class="text-lg font-bold text-gray-800 dark:text-white line-clamp-2"></h4>
                                <p id="videoUploader" class="text-sm text-[var(--m3-primary)] font-medium mt-1"></p>
                                <p id="videoDesc" class="text-xs text-gray-500 mt-2 line-clamp-2"></p>
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <button id="btnMP4"
                            class="m3-button m3-button-tonal flex items-center justify-center gap-3 py-4 border-2 border-transparent transition-all active-format"
                            onclick="setFormat('mp4')">
                            <span class="material-icons-round">movie</span>
                            <div class="text-left">
                                <div class="font-bold">Video (MP4)</div>
                                <div class="text-[10px] opacity-70">Beste Videoqualität</div>
                            </div>
                        </button>
                        <button id="btnMP3"
                            class="m3-button m3-button-tonal flex items-center justify-center gap-3 py-4 border-2 border-transparent transition-all"
                            onclick="setFormat('mp3')">
                            <span class="material-icons-round">music_note</span>
                            <div class="text-left">
                                <div class="font-bold">Audio (MP3)</div>
                                <div class="text-[10px] opacity-70">Nur Tonspur extrahieren</div>
                            </div>
                        </button>
                    </div>

                    <div id="loadingState" class="hidden">
                        <div class="flex flex-col items-center justify-center py-8 gap-4">
                            <div
                                class="w-12 h-12 border-4 border-blue-600/20 border-t-blue-600 rounded-full animate-spin">
                            </div>
                            <p id="loadingText"
                                class="text-sm font-medium text-gray-600 dark:text-gray-400 text-center">Das Medium wird
                                verarbeitet... Bitte hab einen Moment Geduld.</p>
                        </div>
                    </div>

                    <button id="downloadBtn"
                        class="m3-button m3-button-filled w-full py-5 text-xl mt-4 shadow-lg shadow-blue-500/20"
                        onclick="startDownload()">
                        <span class="material-icons-round text-2xl">download</span>
                        Jetzt herunterladen
                    </button>
                </div>

                <div
                    class="bg-blue-50 dark:bg-blue-900/10 p-5 rounded-3xl text-sm text-blue-700 dark:text-blue-300 flex items-start gap-4 border border-blue-100 dark:border-blue-900/30">
                    <span class="material-icons-round text-blue-500">info</span>
                    <div>
                        <p class="font-bold mb-1">Info zur Verarbeitung</p>
                        <p class="opacity-80">Der Download kann je nach Videolänge und Qualität einige Sekunden bis
                            Minuten dauern. Bitte schließe das Fenster nicht.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .active-format {
        border-color: var(--m3-primary) !important;
        background-color: var(--m3-primary-container) !important;
        color: var(--m3-on-primary-container) !important;
    }
</style>

<script>
    let selectedFormat = 'mp4';

    function setFormat(fmt) {
        selectedFormat = fmt;
        document.getElementById('btnMP4').classList.toggle('active-format', fmt === 'mp4');
        document.getElementById('btnMP3').classList.toggle('active-format', fmt === 'mp3');
    }

    function formatDuration(seconds) {
        if (!seconds) return '--:--';
        const h = Math.floor(seconds / 3600);
        const m = Math.floor((seconds % 3600) / 60);
        const s = seconds % 60;
        return [
            h > 0 ? h : null,
            (h > 0 && m < 10 ? '0' : '') + m,
            (s < 10 ? '0' : '') + s
        ].filter(Boolean).join(':');
    }

    async function fetchInfo() {
        const url = document.getElementById('mediaUrl').value.trim();
        const preview = document.getElementById('previewCard');
        const searchBtn = document.getElementById('searchBtn');
        const loader = document.getElementById('loadingState');
        const loadingText = document.getElementById('loadingText');

        if (!url) {
            showToast('Bitte gib einen Link ein.');
            return;
        }

        searchBtn.disabled = true;
        preview.classList.add('hidden');
        loader.classList.remove('hidden');
        loadingText.innerText = 'Informationen werden abgerufen...';

        try {
            const response = await fetch('/api/tools/video-downloader/info', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ url: url })
            });

            const data = await response.json();

            if (response.ok) {
                document.getElementById('videoThumbnail').src = data.thumbnail;
                document.getElementById('videoTitle').innerText = data.title;
                document.getElementById('videoUploader').innerText = data.uploader || 'Unbekannt';
                document.getElementById('videoDuration').innerText = formatDuration(data.duration);
                document.getElementById('videoDesc').innerText = data.description;

                preview.classList.remove('hidden');
            } else {
                showToast(data.error || 'Fehler beim Abrufen der Video-Infos');
            }
        } catch (err) {
            showToast('Netzwerkfehler');
        } finally {
            searchBtn.disabled = false;
            loader.classList.add('hidden');
        }
    }

    async function startDownload() {
        const url = document.getElementById('mediaUrl').value.trim();
        const btn = document.getElementById('downloadBtn');
        const loader = document.getElementById('loadingState');
        const loadingText = document.getElementById('loadingText');

        if (!url) {
            showToast('Bitte gib einen Link ein.');
            return;
        }

        btn.disabled = true;
        btn.classList.add('opacity-50');
        loader.classList.remove('hidden');
        loadingText.innerText = 'Das Medium wird verarbeitet... Bitte hab einen Moment Geduld.';
        showToast('Download gestartet...');

        try {
            const response = await fetch('/api/tools/video-downloader/download', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ url: url, format: selectedFormat })
            });

            if (response.ok) {
                const blob = await response.blob();
                const contentDisposition = response.headers.get('Content-Disposition');
                let filename = `download.${selectedFormat}`;

                if (contentDisposition && contentDisposition.indexOf('attachment') !== -1) {
                    const filenameRegex = /filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/;
                    const matches = filenameRegex.exec(contentDisposition);
                    if (matches != null && matches[1]) {
                        filename = matches[1].replace(/['"]/g, '');
                    }
                }

                const downloadUrl = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = downloadUrl;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                a.remove();

                showToast('Erfolgreich heruntergeladen!');
            } else {
                const data = await response.json();
                showToast(data.error || 'Fehler beim Download');
            }
        } catch (err) {
            console.error(err);
            showToast('Netzwerkfehler oder Zeitüberschreitung');
        } finally {
            btn.disabled = false;
            btn.classList.remove('opacity-50');
            loader.classList.add('hidden');
        }
    }
</script>
{% endblock %}