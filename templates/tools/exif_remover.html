{% extends "base.html" %}

{% block title %}Exif-Daten Entferner{% endblock %}

{% block content %}
<div class="tool-page-container">
    <div class="page-header">
        <a href="{{ url_for('dashboard') }}"
            class="p-4 hover:bg-gray-100 dark:hover:bg-gray-800 rounded-full transition-colors">
            <span class="material-icons-round text-2xl">arrow_back</span>
        </a>
        <h2 class="text-3xl font-bold text-gray-800 dark:text-gray-100">Exif-Daten Entferner</h2>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <!-- Upload & Preview Area -->
        <div class="lg:col-span-1 space-y-6">
            <div class="m3-card space-y-4">
                <input type="file" id="imageInput" accept="image/jpeg,image/png,image/webp" class="hidden"
                    onchange="analyzeImage()">
                <div onclick="document.getElementById('imageInput').click()"
                    class="border-2 border-dashed border-gray-300 dark:border-gray-700 rounded-2xl p-8 text-center cursor-pointer hover:border-blue-500 hover:bg-blue-50 dark:hover:bg-blue-900/10 transition-all group">
                    <span
                        class="material-icons-round text-4xl text-gray-400 group-hover:text-blue-500 mb-2">add_photo_alternate</span>
                    <p class="text-sm font-bold text-gray-500 group-hover:text-blue-600">Bild auswählen</p>
                    <p class="text-xs text-gray-400 mt-1">JPEG, PNG, WEBP</p>
                </div>
            </div>

            <!-- Global Actions -->
            <div id="actionsContainer"
                class="hidden m3-card space-y-4 !bg-blue-50 dark:!bg-blue-900/10 border border-blue-100 dark:border-blue-900/30">
                <h3 class="text-lg font-bold text-blue-800 dark:text-blue-300">Aktionen</h3>
                <button onclick="cleanAll()" class="m3-button m3-button-filled w-full !bg-red-600 hover:!bg-red-700">
                    <span class="material-icons-round mr-2">delete_forever</span>
                    Alle Metadaten löschen
                </button>
                <button onclick="saveChanges()" class="m3-button m3-button-outline w-full bg-white dark:bg-transparent">
                    <span class="material-icons-round mr-2">save</span>
                    Änderungen speichern
                </button>
            </div>
        </div>

        <!-- Metadata List -->
        <div class="lg:col-span-2">
            <div id="loading" class="hidden flex justify-center py-12">
                <span class="material-icons-round animate-spin text-4xl text-blue-600">autorenew</span>
            </div>

            <div id="metadataContainer" class="hidden m3-card !p-0 overflow-hidden">
                <div
                    class="p-6 border-b border-gray-100 dark:border-gray-800 bg-gray-50 dark:bg-gray-800/50 flex justify-between items-center">
                    <h3 class="font-bold text-gray-700 dark:text-gray-200">Gefundene Metadaten</h3>
                    <span id="tagCount"
                        class="text-xs bg-blue-100 dark:bg-blue-900 text-blue-700 dark:text-blue-300 px-2 py-1 rounded-full font-bold">0
                        Tags</span>
                </div>

                <div class="overflow-x-auto">
                    <table class="w-full text-left">
                        <thead
                            class="bg-white dark:bg-gray-900 text-xs uppercase text-gray-400 font-bold border-b border-gray-100 dark:border-gray-800">
                            <tr>
                                <th class="px-6 py-4">Tag Name</th>
                                <th class="px-6 py-4">Wert</th>
                                <th class="px-6 py-4 text-right">Löschen</th>
                            </tr>
                        </thead>
                        <tbody id="metadataTable" class="divide-y divide-gray-50 dark:divide-gray-800">
                            <!-- Rows injected here -->
                        </tbody>
                    </table>
                </div>

                <div id="noDataMessage" class="hidden p-12 text-center text-gray-400">
                    <span class="material-icons-round text-4xl mb-2 opacity-50">data_array</span>
                    <p>Keine Exif-Daten gefunden!</p>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    let currentToken = null;
    let originalFilename = '';

    async function analyzeImage() {
        const fileInput = document.getElementById('imageInput');
        const file = fileInput.files[0];
        if (!file) return;

        originalFilename = file.name;
        const formData = new FormData();
        formData.append('file', file);

        // UI Reset
        document.getElementById('loading').classList.remove('hidden');
        document.getElementById('metadataContainer').classList.add('hidden');
        document.getElementById('actionsContainer').classList.add('hidden');

        try {
            const res = await fetch('/api/tools/exif/analyze', {
                method: 'POST',
                body: formData
            });
            const data = await res.json();

            if (res.ok) {
                currentToken = data.token;
                renderMetadata(data.exif);
                document.getElementById('actionsContainer').classList.remove('hidden');
            } else {
                showToast(data.error || 'Fehler beim Analysieren');
            }
        } catch (e) {
            showToast('Verbindungsfehler');
        } finally {
            document.getElementById('loading').classList.add('hidden');
        }
    }

    function renderMetadata(exif) {
        const container = document.getElementById('metadataContainer');
        const table = document.getElementById('metadataTable');
        const noData = document.getElementById('noDataMessage');
        const countBadge = document.getElementById('tagCount');

        container.classList.remove('hidden');
        table.innerHTML = '';

        const keys = Object.keys(exif);
        countBadge.textContent = `${keys.length} Tags`;

        if (keys.length === 0) {
            noData.classList.remove('hidden');
            return;
        }
        noData.classList.add('hidden');

        keys.forEach(tagId => {
            const item = exif[tagId];
            const row = document.createElement('tr');
            row.className = 'group hover:bg-gray-50 dark:hover:bg-gray-800/50 transition-colors';
            row.innerHTML = `
                <td class="px-6 py-4 text-sm font-medium text-gray-600 dark:text-gray-300">${item.name}</td>
                <td class="px-6 py-4">
                    <input type="text" class="w-full bg-transparent border-none text-sm text-gray-800 dark:text-gray-200 focus:ring-0 p-0" 
                        value="${item.value}" data-tag-id="${tagId}">
                </td>
                <td class="px-6 py-4 text-right">
                    <label class="cursor-pointer">
                        <input type="checkbox" class="delete-checkbox rounded text-red-600 focus:ring-red-500 border-gray-300 dark:border-gray-600 bg-gray-100 dark:bg-gray-700 w-5 h-5" data-tag-id="${tagId}">
                    </label>
                </td>
            `;
            table.appendChild(row);
        });
    }

    async function cleanAll() {
        if (!currentToken) return;

        const res = await fetch('/api/tools/exif/process', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                token: currentToken,
                action: 'clean'
            })
        });

        if (res.ok) {
            const blob = await res.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `clean_${originalFilename}`;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            showToast('Bild (ohne Metadaten) heruntergeladen!');
        } else {
            showToast('Fehler beim Bereinigen');
        }
    }

    async function saveChanges() {
        if (!currentToken) return;

        const inputs = document.querySelectorAll('#metadataTable input[type="text"]');
        const deletes = document.querySelectorAll('.delete-checkbox:checked');
        const updates = {};

        // Collect deletions (mark as empty string to trigger deletion in backend)
        deletes.forEach(cb => {
            updates[cb.dataset.tagId] = "";
        });

        // Collect edits (only if not deleted)
        inputs.forEach(input => {
            const tagId = input.dataset.tagId;
            if (!updates.hasOwnProperty(tagId)) {
                // Only create update if value changed? 
                // For simplicity, we send all values currently visible or just trust the backend handles overwrite without check
                // Better: send all values.
                updates[tagId] = input.value;
            }
        });

        const res = await fetch('/api/tools/exif/process', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                token: currentToken,
                action: 'save',
                updates: updates
            })
        });

        if (res.ok) {
            const blob = await res.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `edited_${originalFilename}`;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            showToast('Änderungen gespeichert!');
        } else {
            showToast('Fehler beim Speichern');
        }
    }
</script>
{% endblock %}