{% extends "base.html" %}

{% block title %}Notizen{% endblock %}

{% block content %}
<div class="tool-page-container h-[calc(100vh-100px)]">
    <div class="page-header">
        <a href="{{ url_for('dashboard') }}"
            class="p-4 hover:bg-gray-100 dark:hover:bg-gray-800 rounded-full transition-colors">
            <span class="material-icons-round text-2xl">arrow_back</span>
        </a>
        <h2 class="text-3xl font-bold text-gray-800 dark:text-gray-100">Meine Notizen</h2>
        <div class="flex-1"></div>
        <button onclick="createNewNote()" class="m3-button m3-button-filled">
            <span class="material-icons-round">add</span>
            Neue Notiz
        </button>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 h-full min-h-0">
        <!-- Sidebar List -->
        <div
            class="m3-card !p-0 flex flex-col overflow-hidden h-full border-r border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-900">
            <div class="p-4 border-b border-gray-100 dark:border-gray-800">
                <input type="text" id="searchNotes" placeholder="Suchen..."
                    class="w-full bg-gray-100 dark:bg-gray-800 rounded-full px-4 py-2 outline-none text-sm"
                    oninput="filterNotes()">
            </div>
            <div class="flex-1 overflow-y-auto" id="notesList">
                <!-- Notes injected here -->
                <div class="flex flex-col items-center justify-center h-40 text-gray-400">
                    <span class="material-icons-round animate-spin">autorenew</span>
                </div>
            </div>
        </div>

        <!-- Editor -->
        <div class="md:col-span-2 m3-card !p-0 flex flex-col h-full bg-white dark:bg-gray-900 overflow-hidden relative"
            id="editorContainer">
            <div id="emptyState"
                class="absolute inset-0 flex flex-col items-center justify-center text-gray-400 bg-gray-50 dark:bg-gray-800 z-10">
                <span class="material-icons-round text-6xl mb-4 opacity-20">edit_note</span>
                <p>Wähle eine Notiz oder erstelle eine neue.</p>
            </div>

            <div class="flex flex-col h-full z-20 bg-white dark:bg-gray-900" id="editor" style="display: none;">
                <div class="flex items-center justify-between p-4 border-b border-gray-100 dark:border-gray-800">
                    <input type="text" id="noteTitle"
                        class="text-xl font-bold bg-transparent outline-none w-full placeholder-gray-400"
                        placeholder="Titel der Notiz" oninput="markUnsaved()">
                    <div class="flex gap-2">
                        <span id="saveStatus" class="text-xs text-gray-400 self-center px-2">Gespeichert</span>
                        <button onclick="deleteNote()"
                            class="p-2 hover:bg-red-50 dark:hover:bg-red-900/20 text-red-500 rounded-full transition-colors"
                            title="Löschen">
                            <span class="material-icons-round">delete</span>
                        </button>
                    </div>
                </div>
                <textarea id="noteContent"
                    class="flex-1 p-6 bg-transparent outline-none resize-none font-sans text-base leading-relaxed"
                    placeholder="Schreibe etwas..." oninput="markUnsaved()"></textarea>
            </div>
        </div>
    </div>
</div>

<script>
    let notes = [];
    let currentNoteId = null;
    let saveTimeout = null;

    async function loadNotes() {
        try {
            const res = await fetch('/api/notes');
            notes = await res.json();
            renderList();
        } catch (e) {
            console.error(e);
            showToast('Fehler beim Laden der Notizen');
        }
    }

    function renderList() {
        const list = document.getElementById('notesList');
        const search = document.getElementById('searchNotes').value.toLowerCase();

        list.innerHTML = '';

        const filtered = notes.filter(n => n.title.toLowerCase().includes(search) || n.content.toLowerCase().includes(search));

        if (filtered.length === 0) {
            list.innerHTML = `<div class="p-8 text-center text-gray-400 text-sm">Keine Notizen gefunden</div>`;
            return;
        }

        filtered.forEach(note => {
            const active = note.id === currentNoteId ? 'bg-blue-50 dark:bg-blue-900/20 border-l-4 border-blue-500' : 'hover:bg-gray-50 dark:hover:bg-gray-800 border-l-4 border-transparent';

            const date = new Date(note.updated_at).toLocaleDateString();
            const preview = note.content.substring(0, 50).replace(/\n/g, ' ') + (note.content.length > 50 ? '...' : '');

            const el = document.createElement('div');
            el.className = `p-4 cursor-pointer transition-all border-b border-gray-100 dark:border-gray-800 ${active}`;
            el.onclick = () => selectNote(note.id);
            el.innerHTML = `
                <h4 class="font-bold text-gray-800 dark:text-gray-200 mb-1 truncate">${note.title || 'Unbenannt'}</h4>
                <p class="text-xs text-gray-500 mb-2 truncate">${preview || 'Kein Inhalt'}</p>
                <span class="text-[10px] text-gray-400 uppercase tracking-wider">${date}</span>
            `;
            list.appendChild(el);
        });
    }

    function filterNotes() {
        renderList();
    }

    async function createNewNote() {
        try {
            const res = await fetch('/api/notes', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ title: 'Neue Notiz', content: '' })
            });
            const newNote = await res.json();
            notes.unshift(newNote);
            selectNote(newNote.id);
            renderList();
            document.getElementById('noteTitle').focus();
            document.getElementById('noteTitle').select();
        } catch (e) {
            showToast('Fehler beim Erstellen');
        }
    }

    function selectNote(id) {
        currentNoteId = id;
        const note = notes.find(n => n.id === id);

        if (!note) return;

        document.getElementById('emptyState').style.display = 'none';
        document.getElementById('editor').style.display = 'flex';

        document.getElementById('noteTitle').value = note.title;
        document.getElementById('noteContent').value = note.content;

        renderList(); // Update active state
        updateSaveStatus('Gespeichert');
    }

    function markUnsaved() {
        updateSaveStatus('Ungespeichert...');
        clearTimeout(saveTimeout);
        saveTimeout = setTimeout(saveCurrentNote, 1000); // Auto-save after 1s
    }

    function updateSaveStatus(status) {
        document.getElementById('saveStatus').innerText = status;
    }

    async function saveCurrentNote() {
        if (!currentNoteId) return;

        const title = document.getElementById('noteTitle').value;
        const content = document.getElementById('noteContent').value;

        updateSaveStatus('Speichere...');

        try {
            await fetch(`/api/notes/${currentNoteId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ title, content })
            });

            // Update local model
            const note = notes.find(n => n.id === currentNoteId);
            if (note) {
                note.title = title;
                note.content = content;
                note.updated_at = new Date().toISOString();

                // Move to top
                notes = notes.filter(n => n.id !== currentNoteId);
                notes.unshift(note);
            }

            renderList();
            updateSaveStatus('Gespeichert');
        } catch (e) {
            updateSaveStatus('Fehler!');
        }
    }

    async function deleteNote() {
        if (!currentNoteId || !confirm('Willst du diese Notiz wirklich löschen?')) return;

        try {
            await fetch(`/api/notes/${currentNoteId}`, { method: 'DELETE' });
            notes = notes.filter(n => n.id !== currentNoteId);
            currentNoteId = null;
            document.getElementById('emptyState').style.display = 'flex';
            document.getElementById('editor').style.display = 'none';
            renderList();
            showToast('Notiz gelöscht');
        } catch (e) {
            showToast('Fehler beim Löschen');
        }
    }

    // Init
    loadNotes();
</script>
{% endblock %}