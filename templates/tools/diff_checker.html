{% extends "base.html" %}

{% block title %}Diff-Checker{% endblock %}

{% block content %}
<div class="tool-page-container">
    <div class="page-header">
        <a href="{{ url_for('dashboard') }}"
            class="p-4 hover:bg-gray-100 dark:hover:bg-gray-800 rounded-full transition-colors">
            <span class="material-icons-round text-2xl">arrow_back</span>
        </a>
        <h2 class="text-3xl font-bold text-gray-800 dark:text-gray-100">Diff-Checker</h2>
    </div>

    <div class="m3-card !p-0 overflow-hidden border-none shadow-xl bg-white dark:bg-gray-900">
        <!-- Input Area -->
        <div
            class="grid grid-cols-1 md:grid-cols-2 divide-y md:divide-y-0 md:divide-x divide-gray-100 dark:divide-gray-800">
            <div class="p-6 space-y-4">
                <div class="flex items-center justify-between">
                    <label class="text-xs font-bold text-gray-500 uppercase tracking-wider">Original Text</label>
                    <button onclick="clearText('original')"
                        class="text-xs text-gray-400 hover:text-red-500 transition-colors uppercase font-bold">Löschen</button>
                </div>
                <textarea id="originalText"
                    class="m3-text-input min-h-[300px] font-mono text-sm leading-relaxed focus:ring-blue-500"
                    placeholder="Füge hier den originalen Text ein..."></textarea>
            </div>
            <div class="p-6 space-y-4">
                <div class="flex items-center justify-between">
                    <label class="text-xs font-bold text-gray-500 uppercase tracking-wider">Geänderter Text</label>
                    <button onclick="clearText('modified')"
                        class="text-xs text-gray-400 hover:text-red-500 transition-colors uppercase font-bold">Löschen</button>
                </div>
                <textarea id="modifiedText"
                    class="m3-text-input min-h-[300px] font-mono text-sm leading-relaxed focus:ring-blue-500"
                    placeholder="Füge hier den geänderten Text ein..."></textarea>
            </div>
        </div>

        <!-- Controls -->
        <div
            class="bg-gray-50 dark:bg-gray-800/50 p-6 flex flex-col sm:flex-row items-center justify-between gap-4 border-t border-gray-100 dark:border-gray-800">
            <div class="flex items-center gap-6">
                <label class="flex items-center gap-3 cursor-pointer group">
                    <input type="radio" name="viewType" value="inline" checked onchange="compare()"
                        class="w-5 h-5 text-blue-600 border-gray-300 focus:ring-blue-500">
                    <span
                        class="text-sm font-medium text-gray-600 dark:text-gray-300 group-hover:text-blue-600 transition-colors">Inline-Ansicht</span>
                </label>
                <label class="flex items-center gap-3 cursor-pointer group">
                    <input type="radio" name="viewType" value="side" onchange="compare()"
                        class="w-5 h-5 text-blue-600 border-gray-300 focus:ring-blue-500">
                    <span
                        class="text-sm font-medium text-gray-600 dark:text-gray-300 group-hover:text-blue-600 transition-colors">Side-by-Side</span>
                </label>
            </div>
            <button onclick="compare()" class="m3-button m3-button-filled w-full sm:w-auto px-10 py-4 text-lg">
                <span class="material-icons-round mr-2">analytics</span>
                Texte vergleichen
            </button>
        </div>

        <!-- Result Area -->
        <div id="resultContainer" class="hidden border-t border-gray-100 dark:border-gray-800">
            <div class="p-6 bg-white dark:bg-gray-900">
                <div class="flex items-center gap-4 mb-6">
                    <h3 class="text-xl font-bold text-gray-800 dark:text-white">Unterschiede</h3>
                    <div class="flex gap-2">
                        <span
                            class="text-[10px] px-2 py-1 bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-400 font-bold uppercase rounded">Hinzugefügt</span>
                        <span
                            class="text-[10px] px-2 py-1 bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-400 font-bold uppercase rounded">Entfernt</span>
                    </div>
                </div>
                <div id="diffOutput"
                    class="font-mono text-sm leading-relaxed p-6 rounded-2xl bg-gray-50 dark:bg-gray-800/30 border border-gray-100 dark:border-gray-800 whitespace-pre-wrap break-all min-h-[100px]">
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .diff-removed {
        background-color: #fee2e2;
        color: #991b1b;
        text-decoration: line-through;
        padding: 0 1px;
        border-radius: 2px;
    }

    .dark .diff-removed {
        background-color: rgba(127, 29, 29, 0.4);
        color: #f87171;
    }

    .diff-added {
        background-color: #dcfce7;
        color: #166534;
        padding: 0 1px;
        border-radius: 2px;
        font-weight: 500;
    }

    .dark .diff-added {
        background-color: rgba(20, 83, 45, 0.4);
        color: #4ade80;
    }

    /* Side-by-Side Styles */
    .diff-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 24px;
    }

    .diff-grid-panel {
        padding: 16px;
        border-radius: 12px;
        background: rgba(0, 0, 0, 0.02);
    }

    .dark .diff-grid-panel {
        background: rgba(255, 255, 255, 0.02);
    }
</style>

<script>
    // Simple Diff Algorithm (Character based)
    function getDiff(text1, text2) {
        let matrix = Array(text1.length + 1).fill().map(() => Array(text2.length + 1).fill(0));

        for (let i = 1; i <= text1.length; i++) {
            for (let j = 1; j <= text2.length; j++) {
                if (text1[i - 1] === text2[j - 1]) {
                    matrix[i][j] = matrix[i - 1][j - 1] + 1;
                } else {
                    matrix[i][j] = Math.max(matrix[i - 1][j], matrix[i][j - 1]);
                }
            }
        }

        let i = text1.length, j = text2.length;
        let diff = [];

        while (i > 0 || j > 0) {
            if (i > 0 && j > 0 && text1[i - 1] === text2[j - 1]) {
                diff.unshift({ type: 'equal', value: text1[i - 1] });
                i--; j--;
            } else if (j > 0 && (i === 0 || matrix[i][j - 1] >= matrix[i - 1][j])) {
                diff.unshift({ type: 'added', value: text2[j - 1] });
                j--;
            } else if (i > 0 && (j === 0 || matrix[i][j - 1] < matrix[i - 1][j])) {
                diff.unshift({ type: 'removed', value: text1[i - 1] });
                i--;
            }
        }
        return diff;
    }

    function compare() {
        const text1 = document.getElementById('originalText').value;
        const text2 = document.getElementById('modifiedText').value;
        const viewType = document.querySelector('input[name="viewType"]:checked').value;
        const output = document.getElementById('diffOutput');
        const container = document.getElementById('resultContainer');

        if (!text1 && !text2) {
            showToast('Bitte Texte zum Vergleichen eingeben.');
            return;
        }

        container.classList.remove('hidden');
        output.innerHTML = '';

        const diff = getDiff(text1, text2);

        if (viewType === 'inline') {
            output.className = 'font-mono text-sm leading-relaxed p-6 rounded-2xl bg-gray-50 dark:bg-gray-800/30 border border-gray-100 dark:border-gray-800 whitespace-pre-wrap break-all';
            diff.forEach(part => {
                const span = document.createElement('span');
                span.textContent = part.value;
                if (part.type === 'added') span.className = 'diff-added';
                if (part.type === 'removed') span.className = 'diff-removed';
                output.appendChild(span);
            });
        } else {
            output.className = 'diff-grid';
            const leftPanel = document.createElement('div');
            const rightPanel = document.createElement('div');
            leftPanel.className = 'diff-grid-panel whitespace-pre-wrap break-all';
            rightPanel.className = 'diff-grid-panel whitespace-pre-wrap break-all';

            diff.forEach(part => {
                const spanL = document.createElement('span');
                const spanR = document.createElement('span');
                spanL.textContent = part.value;
                spanR.textContent = part.value;

                if (part.type === 'equal') {
                    leftPanel.appendChild(spanL);
                    rightPanel.appendChild(spanR);
                } else if (part.type === 'removed') {
                    spanL.className = 'diff-removed';
                    leftPanel.appendChild(spanL);
                } else if (part.type === 'added') {
                    spanR.className = 'diff-added';
                    rightPanel.appendChild(spanR);
                }
            });

            output.appendChild(leftPanel);
            output.appendChild(rightPanel);
        }

        container.scrollIntoView({ behavior: 'smooth' });
    }

    function clearText(id) {
        document.getElementById(id + 'Text').value = '';
        document.getElementById('resultContainer').classList.add('hidden');
    }

    // Auto-compare on input delayer
    let timeout;
    document.getElementById('originalText').addEventListener('input', () => {
        clearTimeout(timeout);
        timeout = setTimeout(compare, 1000);
    });
    document.getElementById('modifiedText').addEventListener('input', () => {
        clearTimeout(timeout);
        timeout = setTimeout(compare, 1000);
    });
</script>
{% endblock %}